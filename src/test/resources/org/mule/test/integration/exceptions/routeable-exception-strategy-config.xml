<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:vm="http://www.mulesoft.org/schema/mule/vm"
       xmlns:test="http://www.mulesoft.org/schema/mule/test"
       xmlns:script="http://www.mulesoft.org/schema/mule/scripting"
       xsi:schemaLocation="
               http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/3.1/mule.xsd
               http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/3.1/mule-vm.xsd
               http://www.mulesoft.org/schema/mule/test http://www.mulesoft.org/schema/mule/test/3.1/mule-test.xsd
               http://www.mulesoft.org/schema/mule/scripting http://www.mulesoft.org/schema/mule/scripting/3.1/mule-scripting.xsd">

    <script:transformer name="duplicateTransformer">
        <script:script engine="groovy">
            return src * 2
        </script:script>
    </script:transformer>

    <script:transformer name="failingIncTransformer">
        <script:script engine="groovy">
            import org.mule.api.transformer.TransformerException;
            import org.mule.config.i18n.CoreMessages;
    
            if (src % 2 == 0)
            {
              throw new TransformerException(CoreMessages.failedToReadPayload());
            }
            else
            {
              return src + 1;
            }
        </script:script>
    </script:transformer>

    <model>
        <service name="TestSyncTransactionalErrorHandling">
            <inbound>
                <vm:inbound-endpoint name="in" path="in" transformer-refs="failingIncTransformer" />
            </inbound>
            <outbound>
                <pass-through-router>
                    <vm:outbound-endpoint name="out" path="out" />
                </pass-through-router>
            </outbound>
            <routeable-exception-strategy>
                <rollback-transaction exception-pattern="*" />
                <pass-through-router>
                    <vm:outbound-endpoint name="exception" path="exception" transformer-refs="duplicateTransformer" />
                </pass-through-router>
            </routeable-exception-strategy>
        </service>
    </model>
</mule>
