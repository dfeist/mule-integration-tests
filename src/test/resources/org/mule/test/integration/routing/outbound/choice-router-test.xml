<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:mule="http://www.mulesoft.org/schema/mule/core" xmlns:vm="http://www.mulesoft.org/schema/mule/vm"
  xmlns:test="http://www.mulesoft.org/schema/mule/test"
  xsi:schemaLocation="
       http://www.mulesoft.org/schema/mule/test http://www.mulesoft.org/schema/mule/test/3.0/mule-test.xsd
       http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/3.0/mule-vm.xsd
       http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/3.0/mule.xsd">

  <vm:endpoint name="valid-channel" path="valid-channel.in"
    exchange-pattern="request-response">
    <append-string-transformer message=":valid" />
  </vm:endpoint>

  <vm:endpoint name="default-channel" path="default-channel.in"
    exchange-pattern="request-response">
    <append-string-transformer message=":default" />
  </vm:endpoint>

  <flow name="no-default-route">
    <vm:inbound-endpoint path="no-default-route.in"
      exchange-pattern="request-response" />
    <choice>
      <when>
        <outbound-endpoint ref="valid-channel" />
        <regex-filter pattern="valid" />
      </when>
    </choice>
  </flow>

  <flow name="default-route">
    <vm:inbound-endpoint path="default-route.in"
      exchange-pattern="request-response" />
    <choice>
      <when>
        <outbound-endpoint ref="valid-channel" />
        <regex-filter pattern="valid" />
      </when>
      <otherwise>
        <outbound-endpoint ref="default-channel" />
      </otherwise>
    </choice>
  </flow>

  <simple-service name="valid-service" endpoint-ref="valid-channel"
    component-class="org.mule.component.simple.EchoComponent" />

  <simple-service name="default-service" parent="valid-service"
    endpoint-ref="default-channel" />
</mule>
