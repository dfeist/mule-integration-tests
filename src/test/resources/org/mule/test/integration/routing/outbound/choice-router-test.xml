<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:mule="http://www.mulesoft.org/schema/mule/core" xmlns:vm="http://www.mulesoft.org/schema/mule/vm"
  xmlns:test="http://www.mulesoft.org/schema/mule/test"
  xsi:schemaLocation="
       http://www.mulesoft.org/schema/mule/test http://www.mulesoft.org/schema/mule/test/3.0/mule-test.xsd
       http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/3.0/mule-vm.xsd
       http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/3.0/mule.xsd">

  <flow name="without-default-route">
    <vm:inbound-endpoint path="without-default-route.in" exchange-pattern="request-response" />
    <choice>
      <when>
        <outbound-endpoint ref="fruit-channel" />
        <regex-filter pattern="apple" />
      </when>
    </choice>
  </flow>

  <flow name="with-default-route">
    <vm:inbound-endpoint path="with-default-route.in" exchange-pattern="request-response" />
    <choice>
      <when>
        <outbound-endpoint ref="fruit-channel" />
        <regex-filter pattern="apple" />
      </when>
      <when>
        <outbound-endpoint ref="veggie-channel" />
        <regex-filter pattern="turnip" />
      </when>
      <when expression="#[regex:.*berry]">
        <outbound-endpoint ref="fruit-channel" />
      </when>
      <otherwise>
        <outbound-endpoint ref="default-channel" />
      </otherwise>
    </choice>
  </flow>

  <vm:endpoint name="fruit-channel" path="fruit-channel.in" exchange-pattern="request-response">
    <append-string-transformer message=":fruit" />
  </vm:endpoint>

  <vm:endpoint name="veggie-channel" path="veggie-channel.in" exchange-pattern="request-response">
    <append-string-transformer message=":veggie" />
  </vm:endpoint>

  <vm:endpoint name="default-channel" path="default-channel.in" exchange-pattern="request-response">
    <append-string-transformer message=":default" />
  </vm:endpoint>
  
  <simple-service name="fruit-service" endpoint-ref="fruit-channel"
    component-class="org.mule.component.simple.EchoComponent" />

  <simple-service name="veggie-service" endpoint-ref="veggie-channel"
    component-class="org.mule.component.simple.EchoComponent" />

  <simple-service name="default-service" endpoint-ref="default-channel"
    component-class="org.mule.component.simple.EchoComponent"/>
</mule>
